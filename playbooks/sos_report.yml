---
- name: Gather SOS Report(s)
  hosts: all
  gather_facts: false
  tasks:
    - name: Call sos_report role
      ansible.builtin.include_role:
        name: sos_report

    - name: Upload Block
      delegate_to: localhost
      run_once: true
      when:
        - upload | bool | default(true)
      block:
        - name: Aggregate 'case_updates_needed' data from all hosts
          ansible.builtin.set_fact:
            case_updates_needed: |
              {% set combined_list = [] %}
              {% for host in ansible_play_hosts %}
              {%   if hostvars[host].case_updates_needed is defined %}
              {%     set _ = combined_list.extend(hostvars[host].case_updates_needed) %}
              {%   endif %}
              {% endfor %}
              {{ combined_list }}

        - name: Call rh_token_refresh role
          ansible.builtin.include_role:
            name: rh_token_refresh

        - name: Call rh_case_update role
          ansible.builtin.include_role:
            name: rh_case_update
...
