---
- name: Case Updates Loop | Print on screen role execution status.
  ansible.builtin.debug:
    msg:
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
      - " {{ message_text }} "
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
  vars:
    message_text: "Starting Case Update and Attachment Loop for Case ID {{ case_id }}"
  run_once: true

# --- Proxy Definition Tasks ---
# (These tasks correctly define the proxy_cmd variable based on rh_use_proxy)
- name: Attachment Upload | Define proxy command (if required)
  ansible.builtin.set_fact:
    proxy_cmd: " --proxy {{ rh_http_proxy }} "
  when: rh_use_proxy | default(false)
  
- name: Attachment Upload | Define proxy command (default)
  ansible.builtin.set_fact:
    proxy_cmd: ""
  when: not rh_use_proxy | default(false)

- name: Attachment Upload | Ensure HTTP Proxy is not used for non-proxied environments
  ansible.builtin.set_fact:
    # Ensure environment variables are clear if not using a proxy to avoid conflicts
    https_proxy: ""
    http_proxy: ""
  when: not rh_use_proxy | default(false)

# --- Curl Execution Task ---
- name: "Attachment Upload | Upload attachment to case {{ case_id ~ ' | ' ~ case_update.attachment | basename }}"
  ansible.builtin.shell: |
    curl -s -X POST \
      -w "\nHTTP_STATUS:%{http_code}" \
      --max-time {{ rh_case_update_timeout }} \
      -H "Authorization: Bearer {{ rh_token_refresh_api_access_token }}" \
      {{ proxy_cmd | default('') }} \
      -F "file=@{{ case_update.attachment }};filename={{ case_update.attachment | basename }}" \
      -F "description={{ case_update.attachmentDescription | default('') }}" \
      "{{ rh_api_base_url }}/support/v1/cases/{{ case_id }}/attachments/"
  register: upload_cli_result
  no_log: "{{ var_no_log | default('true') }}" # <--- To keep sensitive values out of Ansible output logs
  failed_when: false
  changed_when: upload_cli_result.rc == 0

# --- Parsing and Validation Tasks ---
- name: Attachment Upload | Parse curl output from loop
  ansible.builtin.set_fact:
    __curl_stdout: "{{ upload_cli_result.stdout | default('N/A') }}"
    __curl_stderr: "{{ upload_cli_result.stderr | default('N/A') }}"
    __curl_rc: "{{ upload_cli_result.rc | default('N/A') }}"

- name: Attachment Upload | Extract HTTP status and response body
  ansible.builtin.set_fact:
    upload_status: "{{ (__curl_stdout | regex_search('HTTP_STATUS:(\\d+)', '\\1') | first | default(0)) | int }}"
    upload_body_raw: "{{ __curl_stdout | regex_replace('\\nHTTP_STATUS:.*$', '') }}"

- name: Attachment Upload | Assert upload succeeded (HTTP 20x)
  ansible.builtin.assert:
    that:
      - __curl_rc | int == 0
      - upload_status | int in [200, 201]
    success_msg: >-
      PASSED! Oh, Yes! => Attachment uploaded successfully to case {{ case_id }}! HTTP Status: {{ upload_status }}, Proceeding to next step...
    fail_msg: >-
      FAILED! Oh, No! => Attachment upload failed! Curl RC: {{ __curl_rc }} | HTTP Status: {{ upload_status }} | Stderr: {{ __curl_stderr }} | Response Body: {{ upload_body_raw }}

- name: Attachment Upload | Set final JSON response from successful upload
  ansible.builtin.set_fact:
    upload_result_json: "{{ upload_body_raw }}"

- name: Attachment Upload | Print on screen role completion status.
  ansible.builtin.debug:
    msg:
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
      - " {{ message_text }} "
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
  vars:
    message_text: "Completed Attachment Upload for Case ID {{ case_id }}"
  run_once: true
...
