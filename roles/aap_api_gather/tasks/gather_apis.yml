---
# Tasks to gather data from selected AAP component APIs

- name: Gather APIs | Verify API token is available
  ansible.builtin.assert:
    that:
      - aap_api_gather_aap_token is defined
      - aap_api_gather_aap_token | length > 0
    fail_msg: "AAP API Token is not available. Ensure aap_api_token role runs before this role and sets aap_token fact."
    quiet: true
  run_once: true

- name: Gather APIs | Loop through selected components
  loop: "{{ aap_api_gather_components }}"
  loop_control:
    loop_var: component_name
    label: "Querying {{ component_name }} endpoints"
  vars:
    # Determine the base URL for the current component
    # Controller and Gateway: use hostname
    # Hub: use aap_hub_url if provided, otherwise fallback to hostname
    # EDA: use aap_eda_url if provided, otherwise fallback to hostname
    _base_url: >-
      {{
        'https://' + aap_api_gather_aap_hostname if component_name in ['controller', 'gateway']
        else ('https://' + aap_api_gather_aap_hub_url if component_name == 'hub' and (aap_api_gather_aap_hub_url | length > 0)
        else ('https://' + aap_api_gather_aap_hostname if component_name == 'hub'
        else ('https://' + aap_api_gather_aap_eda_url if component_name == 'eda' and (aap_api_gather_aap_eda_url | length > 0)
        else ('https://' + aap_api_gather_aap_hostname if component_name == 'eda'
        else ''))))
      }}
    # Define the list of endpoints for the current component
    _endpoints: "{{ aap_api_endpoints[component_name] | default([]) }}"
    # Define the destination directory for this host and component
    _component_dest_dir: "{{ aap_api_gather_dest }}/{{ inventory_hostname }}/{{ component_name }}"
  ansible.builtin.include_tasks: gather_apis_component_loop.yml
...
