---
# Recursive task file for handling pagination
# This file is included recursively until all pages are fetched

- name: Gather APIs | Pagination | Query endpoint page {{ _current_page }}
  ansible.builtin.uri:
    url: "{{ _next_url }}"
    method: GET
    headers:
      Authorization: "Bearer {{ aap_api_gather_aap_token.token | default(aap_api_gather_aap_token) }}"
      Accept: "application/json"
    return_content: true
    validate_certs: "{{ aap_api_gather_aap_validate_certs }}"
    status_code: 200 # Expect success
    # Increase timeout if needed for slow endpoints
    # timeout: 60
  register: api_result
  ignore_errors: true # Continue if one endpoint fails
  failed_when: false # Never fail, always continue

- name: Gather APIs | Pagination | Handle successful response
  when: api_result is defined and api_result.status is defined and api_result.status == 200 and api_result.content is defined
  block:
    - name: Gather APIs | Pagination | Prepare filename base
      ansible.builtin.set_fact:
        _safe_filename_base: "{{ _safe_filename | default('unknown') | regex_replace('\\.json$', '') }}"

    - name: Gather APIs | Pagination | Set page suffix
      ansible.builtin.set_fact:
        _page_suffix: "_page{{ _current_page }}"

    - name: Gather APIs | Pagination | Generate filename with page number
      ansible.builtin.set_fact:
        _paged_filename: "{{ _safe_filename_base }}{{ _page_suffix }}.json"

    - name: Gather APIs | Pagination | Set output file path
      ansible.builtin.set_fact:
        _paged_output_file_path: "{{ _component_dest_dir }}/{{ _paged_filename }}"

    - name: Gather APIs | Pagination | Save output for page {{ _current_page }}
      ansible.builtin.copy:
        content: "{{ api_result.json | to_nice_json }}"
        dest: "{{ _paged_output_file_path }}"
        mode: '0644'
      delegate_to: localhost # Save on control node

    - name: Gather APIs | Pagination | Check for next page
      when: api_result.json is defined
      block:
        - name: Gather APIs | Pagination | Extract next URL
          ansible.builtin.set_fact:
            _next_url: "{{ api_result.json.next | default('') }}"
            _has_next_page: "{{ api_result.json.next is defined and api_result.json.next is not none and api_result.json.next != '' }}"

        - name: Gather APIs | Pagination | Convert max pages to integer
          ansible.builtin.set_fact:
            _max_pages_int: "{{ _max_pages | int }}"

        - name: Gather APIs | Pagination | Check max pages limit
          ansible.builtin.set_fact:
            _max_pages_reached: "{{ _max_pages_int | int > 0 and (_current_page | int) >= _max_pages_int | int }}"

        - name: Gather APIs | Pagination | Build full URL for next page if relative
          when: _has_next_page | bool and not (_next_url | regex_search('^https?://'))
          ansible.builtin.set_fact:
            _next_url: "{{ _base_url }}{{ _next_url }}"

        - name: Gather APIs | Pagination | Check if max pages limit reached
          ansible.builtin.debug:
            msg: "Reached maximum page limit ({{ _max_pages }}) for this endpoint. Stopping pagination."
          when: _max_pages_reached | bool

        - name: Gather APIs | Pagination | Fetch next page if available and within limits
          when: _has_next_page | bool and not (_max_pages_reached | bool)
          block:
            - name: Gather APIs | Pagination | Increment page number
              ansible.builtin.set_fact:
                _current_page: "{{ _current_page | int + 1 }}"

            - name: Gather APIs | Pagination | Recursively fetch next page
              ansible.builtin.include_tasks: gather_apis_pagination.yml

- name: Gather APIs | Pagination | Handle failed response
  when: api_result is not defined or api_result.status is not defined or api_result.status != 200
  block:
    - name: Gather APIs | Pagination | Extract error message
      ansible.builtin.set_fact:
        _error_msg: >-
          {{
            api_result.msg | default('') if api_result is defined and api_result.msg is defined
            else (api_result.body | default('') if api_result is defined and api_result.body is defined
            else (api_result.json | default({}) | to_json | default('') if api_result is defined and api_result.json is defined
            else 'Request failed - no response received' if api_result is not defined
            else 'Unknown error' if api_result is defined
            else 'No details available'))
          }}

    - name: Gather APIs | Pagination | Build failure dict
      ansible.builtin.set_fact:
        _failure_dict:
          component: "{{ component_name }}"
          endpoint: "{{ endpoint_path }}"
          url: "{{ _next_url }}"
          status_code: "{{ api_result.status | default('N/A') if api_result is defined else 'N/A' }}"
          error_message: "{{ _error_msg | default('No details available') }}"
          page: "{{ _current_page }}"

    - name: Gather APIs | Pagination | Register failure in fact
      ansible.builtin.set_fact:
        aap_api_gather_failures: "{{ aap_api_gather_failures | default([]) + [_failure_dict] }}"
      run_once: true

    - name: Gather APIs | Pagination | Log warning
      ansible.builtin.debug:
        msg: >-
          Warning: Failed to query {{ _next_url }} (page {{ _current_page }}).
          Status: {{ api_result.status | default('N/A') if api_result is defined else 'N/A' }}.
          Error: {{ _error_msg }}
