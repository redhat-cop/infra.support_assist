---
# Recursive task file for handling pagination
# This file is included recursively until all pages are fetched

- name: Gather APIs | Pagination | Query endpoint page {{ _current_page }}
  ansible.builtin.uri:
    url: "{{ _next_url }}"
    method: GET
    headers:
      Authorization: "Bearer {{ aap_api_gather_aap_token.token | default(aap_api_gather_aap_token) }}"
      Accept: "application/json"
    return_content: true
    validate_certs: "{{ aap_api_gather_aap_validate_certs }}"
    status_code: 200 # Expect success
    # Increase timeout if needed for slow endpoints
    # timeout: 60
  register: api_result
  ignore_errors: true # Continue if one endpoint fails
  failed_when: false # Never fail, always continue

- name: Gather APIs | Pagination | Handle successful response
  when: api_result is defined and api_result.status is defined and api_result.status == 200 and api_result.content is defined
  block:
    - name: Gather APIs | Pagination | Save output for page {{ _current_page }}
      ansible.builtin.copy:
        content: "{{ api_result.json | to_nice_json }}"
        dest: "{{ _component_dest_dir }}/{{ _safe_filename | default('unknown') | regex_replace('\\.json$', '') }}_page{{ _current_page }}.json"
        mode: '0644'
      delegate_to: localhost # Save on control node

    - name: Gather APIs | Pagination | Check for next page and prepare variables
      when: api_result.json is defined
      vars:
        _next_url_raw: "{{ api_result.json.next | default('') }}"
        _has_next_page: "{{ api_result.json.next is defined and api_result.json.next is not none and api_result.json.next != '' }}"
        _max_pages_reached: "{{ ((_max_pages | int) > 0) and ((_current_page | int) >= (_max_pages | int)) }}"
        _next_url: "{{ (_base_url + _next_url_raw) if (_has_next_page | bool) and not (_next_url_raw | regex_search('^https?://')) else (_next_url_raw if (_has_next_page | bool) else '') }}"
      ansible.builtin.set_fact:
        _has_next_page: "{{ _has_next_page }}"
        _max_pages_reached: "{{ _max_pages_reached }}"
        _next_url: "{{ _next_url }}"

    - name: Gather APIs | Pagination | Log max pages limit reached
      ansible.builtin.debug:
        msg: "Reached maximum page limit ({{ _max_pages }}) for this endpoint. Stopping pagination."
      when: _max_pages_reached | bool

    - name: Gather APIs | Pagination | Fetch next page if available and within limits
      when: _has_next_page | bool and not (_max_pages_reached | bool)
      block:
        - name: Gather APIs | Pagination | Increment page number
          ansible.builtin.set_fact:
            _current_page: "{{ _current_page | int + 1 }}"

        - name: Gather APIs | Pagination | Recursively fetch next page
          ansible.builtin.include_tasks: gather_apis_pagination.yml

- name: Gather APIs | Pagination | Handle failed response
  when: api_result is not defined or api_result.status is not defined or api_result.status != 200
  block:
    - name: Gather APIs | Pagination | Register failure and log warning
      ansible.builtin.set_fact:
        aap_api_gather_failures: "{{ aap_api_gather_failures | default([]) + [{
          'component': component_name,
          'endpoint': endpoint_path,
          'url': _next_url,
          'status_code': api_result.status | default('N/A') if api_result is defined else 'N/A',
          'error_message': (api_result.msg | default(api_result.body | default(api_result.json | default({}) | to_json | default('Unknown error')))) if api_result is defined else 'Request failed - no response received',
          'page': _current_page
        }] }}"
      run_once: true

    - name: Gather APIs | Pagination | Log warning
      ansible.builtin.debug:
        msg: >-
          Warning: Failed to query {{ _next_url }} (page {{ _current_page }}).
          Status: {{ api_result.status | default('N/A') if api_result is defined else 'N/A' }}.
          Error: {{ (api_result.msg | default(api_result.body | default(api_result.json | default({}) | to_json | default('Unknown error')))) if api_result is defined else 'Request failed - no response received' }}
