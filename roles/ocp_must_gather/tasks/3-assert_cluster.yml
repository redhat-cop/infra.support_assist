# Pre-Flight Cluster pre-flight execution (Post-Login Cluster Validation)
---
- name: Assert Cluster | Print on screen post-login execution status - (Cluster Validation).
  ansible.builtin.debug:
    msg:
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
      - " {{ message_text }} "
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
  vars:
    message_text: "Executing Post-Login Cluster Validation Checks"
  run_once: true

- name: Assert Cluster | Set fact for authenticated SA name
  ansible.builtin.set_fact:
    sa_name: "{{ oc_whoami.stdout | trim | split(':') | last }}"
  when: oc_whoami.rc == 0

- name: Assert Cluster | Check if service account has cluster-admin privileges
  ansible.builtin.shell: |
    oc get clusterrolebindings -o json | \
    jq -r '.items[] | select(.roleRef.name=="cluster-admin") | .subjects[]? | select(.name=="{{ sa_name }}") | .name'
  register: cluster_admin_check
  changed_when: false
  failed_when: false

- name: Assert Cluster | Assert that service account has cluster-admin privileges
  ansible.builtin.assert:
    that:
      # Check if the stripped stdout equals the SA name (meaning the SA was found with the role)
      - cluster_admin_check.stdout.strip() == sa_name
    fail_msg: >-
      FAILED! Oh, No! => The authenticated user/service account '{{ sa_name }}' does NOT have 'cluster-admin' privileges.
      This permission is required to execute 'oc adm must-gather'. 
      Please ensure the correct token or rolebinding is configured when you get a chance and try again. 
      For more information, check the Resolution Link (KCS) - https://access.redhat.com/solutions/6375111
    success_msg: >-
      PASSED! Oh, Yes! => User/Service account '{{ sa_name }}' has 'cluster-admin' privileges, so we are good to go. Proceeding with must-gather execution.
  when: sa_name is defined

- name: Assert Cluster | Check the Cluster ID
  ansible.builtin.shell: |
    oc get clusterversion version -o jsonpath='{.spec.clusterID}'
  register: cluster_id_check
  changed_when: false
  failed_when: false

- name: Assert Cluster | Set fact for cluster_id
  ansible.builtin.set_fact:
    cluster_id: "{{ cluster_id_check.stdout | trim }}"
  when: cluster_id_check.rc == 0

- name: Assert Cluster | Check the Cluster Version
  ansible.builtin.shell: |
    oc get clusterversion version -o jsonpath='{.status.desired.version}'
  register: cluster_version_check
  changed_when: false
  failed_when: false

- name: Assert Cluster | Set fact for cluster_version
  ansible.builtin.set_fact:
    cluster_version: "{{ cluster_version_check.stdout | trim }}"
  when: cluster_version_check.rc == 0

- name: Assert Cluster | Set fact for cluster_version_check stdout to 'case_product_version'
  ansible.builtin.set_fact:
    case_product_version: "{{ cluster_version_check.stdout | default('N/A') }}"
  when: cluster_version_check is defined

- name: Assert Cluster | Get Filesystem Stats using 'df' command
  ansible.builtin.shell: "df -kP {{ ocp_must_gather_dest_dir }} | awk 'NR==2 {print $4}'"
  register: df_result
  changed_when: false
  run_once: true

- name: Assert Cluster | Set Available Space Fact (in Bytes)
  ansible.builtin.set_fact:
    must_gather_space_available: "{{ (df_result.stdout | int) * 1024 }}"
  when: df_result.rc == 0
  run_once: true

- name: Assert Cluster | Assert Minimum Free Space (5 GB Floor)
  ansible.builtin.assert:
    that:
      # Check available space (bytes) > 5 billion bytes (5 GB)
      - must_gather_space_available | int > 5000000000 
    fail_msg: >
      [FATAL] Insufficient local disk space on the Execution Host (EE). 
      Target directory '{{ ocp_must_gather_dest_dir }}' has only 
      {{ (must_gather_space_available | int / (1024*1024*1024)) | round(2) }} GB available. 
      Please ensure at least 5 GB is free.
    success_msg: "PASSED! Oh, Yes! => Disk space validation succeeded. At least 5 GB is available for must-gather output. Proceeding..."
  when: must_gather_space_available is defined
  run_once: true

- name: Assert Cluster | Print available space for must-gather output
  ansible.builtin.debug:
    msg: >
      Available disk space on {{ inventory_hostname }} for must-gather output at '{{ ocp_must_gather_dest_dir }}': 
      {{ (must_gather_space_available | int / (1024*1024*1024)) | round(2) }} GB
  when: must_gather_space_available is defined
  run_once: true

- name: Assert Cluster | Print on screen post-login validation complete
  ansible.builtin.debug:
    msg:
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
      - " {{ message_text }} "
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
  vars:
    message_text: "Post-Login Cluster Validation Checks Completed Successfully"
  run_once: true
...
