# Pre-Flight Cluster pre-flight execution (Post-Login Cluster Validation)
---
- name: Assert Cluster | Print on screen post-login execution status - (Cluster Validation).
  ansible.builtin.debug:
    msg:
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
      - " {{ message_text }} "
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
  vars:
    message_text: "Executing Post-Login Cluster Validation Checks"
  run_once: true

- name: Assert Cluster | Set fact for authenticated SA name
  ansible.builtin.set_fact:
    sa_name: "{{ oc_whoami.stdout | trim | split(':') | last }}"
  when: oc_whoami.rc == 0

- name: Assert Cluster | Check if authenticated account has cluster-admin privileges
  ansible.builtin.shell: |
    set -o pipefail
    oc get clusterrolebindings -o jsonpath='{.items[*].subjects[*].name}' \
      | tr ' ' '\n' \
      | grep -w {{ sa_name }}
  register: cluster_admin_check
  changed_when: false
  failed_when: false

- name: Assert Cluster | Assert that authenticated account has cluster-admin privileges
  ansible.builtin.assert:
    that:
      # Check if the stripped stdout equals the SA name (meaning the SA was found with the role) or the system:admin role
      - (cluster_admin_check.stdout | trim == sa_name) or (cluster_admin_check.stdout | trim == 'system:admin')
    fail_msg: >-
      FAILED! Oh, No! => The authenticated user/service account '{{ sa_name }}' does NOT have 'cluster-admin' or 'system:admin' privileges.
      This permission is required to execute 'oc adm must-gather'.
      Please ensure the correct token or rolebinding is configured when you get a chance and try again.
      For more information, check the Resolution Link (KCS) - https://access.redhat.com/solutions/6375111
    success_msg: >-
      PASSED! Oh, Yes! => User/Service account '{{ sa_name }}' has 'cluster-admin' or 'system:admin' privileges, so we are good to go. Proceeding with must-gather execution.

- name: Assert Cluster | Check the Cluster ID
  ansible.builtin.shell: |
    oc get clusterversion version -o jsonpath='{.spec.clusterID}'
  register: cluster_id_check
  changed_when: false
  failed_when: false

- name: Assert Cluster | Set fact for cluster_id
  ansible.builtin.set_fact:
    cluster_id: "{{ cluster_id_check.stdout | trim }}"
  when: cluster_id_check.rc == 0

- name: Assert Cluster | Check the Cluster Version
  ansible.builtin.shell: |
    oc get clusterversion version -o jsonpath='{.status.desired.version}'
  register: cluster_version_check
  changed_when: false
  failed_when: false

- name: Assert Cluster | Set fact for cluster_version
  ansible.builtin.set_fact:
    cluster_version: "{{ cluster_version_check.stdout | trim }}"
  when: cluster_version_check.rc == 0

- name: Assert Cluster | Set fact for cluster_version_check stdout to 'case_product_version'
  ansible.builtin.set_fact:
    case_product_version: "{{ cluster_version_check.stdout | default('N/A') }}"
  when: cluster_version_check is defined

- name: Assert Cluster | Discover all operators for selected component (AAP multi-namespace support)
  # Use command module to get JSON, then parse with Ansible's json_query filter (no jq required on target host)
  ansible.builtin.command: "{{ selected_component_config.discovery_command }}"
  register: component_discovery_result
  changed_when: false
  failed_when: false
  when:
    - selected_component_config is defined
    - component_key is defined
    - component_key == 'aap'
    - "'discovery_command' in selected_component_config"

- name: Assert Cluster | Parse discovered AAP operators into list using Ansible's json_query filter
  ansible.builtin.set_fact:
    discovered_operators: >-
      {%- set operators = [] -%}
      {%- if component_discovery_result.stdout is defined and component_discovery_result.stdout | trim | length > 0 -%}
        {%- set csv_data = component_discovery_result.stdout | from_json -%}
        {%- if csv_data['items'] is defined -%}
          {%- for item in csv_data['items'] -%}
            {%- if item.spec.displayName is defined and item.spec.displayName == "Ansible Automation Platform" -%}
              {%- set ns = item.metadata.namespace | default('') | trim -%}
              {%- set ver = item.spec.version | default('') | trim -%}
              {%- if ns | length > 0 and ver | length > 0 -%}
                {%- set _ = operators.append({'namespace': ns, 'version': ver}) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endif -%}
      {{ operators }}
  when:
    - component_key is defined
    - component_key == 'aap'
    - component_discovery_result is defined
    - component_discovery_result.rc == 0

- name: Assert Cluster | Execute version command for selected component to retrieve operator version (non-AAP)
  ansible.builtin.command: >-
    {%- if 'version_command' in selected_component_config -%}
      {{- selected_component_config.version_command -}}
    {%- else -%}
      echo "version_command not available"
    {%- endif -%}
  register: component_version_result
  changed_when: false
  failed_when: false
  when:
    - selected_component_config is defined
    - component_key is defined
    - component_key != 'aap'
    - "'version_command' in selected_component_config"

- name: Assert Cluster | Assert that discovery/version command executed successfully
  ansible.builtin.assert:
    that:
      - component_key is defined
      - (component_key == 'aap' and component_discovery_result.rc is defined and component_discovery_result.rc == 0) or
        (component_key != 'aap' and component_version_result.rc is defined and component_version_result.rc == 0)
    fail_msg:
      "FAILED! Oh, No! => The discovery/version command for component {{ component_key | upper }} failed. Please check if the Operator is installed and the authentication is correct."
    success_msg:
      "PASSED! Oh, Yes! => Discovery/version command for component '{{ component_key | upper }}' executed successfully. Proceeding to extract version(s)..."
  when: selected_component_config is defined

- name: Assert Cluster | Assert that at least one AAP operator was discovered
  ansible.builtin.assert:
    that:
      - discovered_operators is defined
      - discovered_operators | length > 0
    fail_msg: >-
      FAILED! Oh, No! => No AAP operators were discovered on the cluster.
      Please ensure AAP is installed and the authentication has proper permissions.
    success_msg: >-
      PASSED! Oh, Yes! => Discovered {{ discovered_operators | length }} AAP operator(s).
      Proceeding to process each operator...
  when:
    - component_key is defined
    - component_key == 'aap'
    - component_discovery_result is defined
    - component_discovery_result.rc == 0

- name: Assert Cluster | Set raw_version fact for consumption (non-AAP)
  ansible.builtin.set_fact:
    raw_version: "{{ component_version_result.stdout | trim }}"
  when:
    - component_version_result is defined
    - component_version_result.rc is defined
    - component_version_result.rc == 0
    - component_key is defined
    - component_key != 'aap'

- name: Assert Cluster | Assert component operator version was successfully retrieved (non-AAP)
  ansible.builtin.assert:
    that:
      - raw_version is defined
      - raw_version | length > 0
    fail_msg: >-
      FAILED! Oh, No! => Component '{{ component_key | upper }}' was selected but the operator version
      could not be retrieved (RC: {{ component_version_result.rc | default('N/A') }}).
      This means the Operator is likely NOT installed, or the authentication is incorrect.
      Check: oc get csv -n <namespace>.
    success_msg: >-
      PASSED! Oh, Yes! => Component '{{ component_key | upper }}' version ({{ raw_version }})
      retrieved successfully. Proceeding to construct the image tag...
  when:
    - raw_version is defined
    - component_key is defined
    - component_key != 'aap'

- name: Assert Cluster | Process each discovered AAP operator and construct images
  ansible.builtin.set_fact:
    aap_operators_processed: >-
      {%- set processed = [] -%}
      {%- for operator in discovered_operators -%}
        {%- set raw_version = operator.version -%}
        {%- set namespace = operator.namespace -%}
        {%- set config = selected_component_config -%}
        {%- set logic = config.tag_logic | trim -%}
        {%- set version_parts = raw_version.split('.') -%}
        {%- set major_minor_tag = version_parts[0] ~ '.' ~ version_parts[1] | default('') -%}
        {%- set major_minor_num_str = major_minor_tag | replace('.', '') -%}
        {%- set final_url = "" -%}
        {%- if logic == 'aap_dynamic_rhel' -%}
          {%- set major_num_int = major_minor_tag.split('.') | first | int -%}
          {%- set rhel_suffix = "/aap-must-gather-rhel8" -%}
          {%- if major_minor_num_str | int >= 26 -%}
            {%- set rhel_suffix = "/aap-must-gather-rhel9" -%}
          {%- endif -%}
          {%- set final_url = config.image_base_prefix ~ major_minor_num_str ~ rhel_suffix -%}
        {%- endif -%}
        {%- set _ = processed.append({
            'namespace': namespace,
            'version': raw_version,
            'image': final_url | trim
          }) -%}
      {%- endfor -%}
      {{ processed }}
  when:
    - component_key is defined
    - component_key == 'aap'
    - discovered_operators is defined
    - discovered_operators | length > 0

- name: Assert Cluster | Construct and set the final versioned image string (non-AAP)
  when:
    - raw_version is defined
    - component_key is defined
    - component_key != 'aap'
  ansible.builtin.set_fact:
    ocp_must_gather_image_custom: >-
      {% set raw_version = raw_version | default('') %}
      {% set config = selected_component_config %}
      {% set logic = config.tag_logic | trim %}

      {# 1. Extract Major.Minor (e.g., '2.6' from '2.6.0+...') #}
      {% set version_parts = raw_version | split('.') %}
      {% set major_minor_tag = version_parts[0] ~ '.' ~ version_parts[1] | default('') %}

      {# 2. Convert Major.Minor (e.g., '2.6') to number string ('26') for AAP path #}
      {% set major_minor_num_str = major_minor_tag | replace('.', '') %}

      {% set final_url = "" %}

      {% if logic == 'raw' %}
        {% set final_url = raw_version %}
      {% elif logic == 'major_minor' %}
        {% set final_url = config.image_base ~ major_minor_tag %}
      {% elif logic == 'aap_dynamic_rhel' %}
        {% set major_num_int = major_minor_tag | split('.') | first | int %}
        {% set rhel_suffix = "/aap-must-gather-rhel8" %}

        {% if major_minor_num_str | int >= 26 %}
          {% set rhel_suffix = "/aap-must-gather-rhel9" %}
        {% endif %}

        {% set final_url = config.image_base_prefix ~ major_minor_num_str ~ rhel_suffix %}

      {% elif logic == 'major_minor_rhel' %}
        {% set is_v3_or_higher = raw_version | split('.') | first | int >= 3 %}
        {% set rhel_tag = 'rhel9' if is_v3_or_higher else 'rhel8' %}
        {% set final_url = config.image_base ~ rhel_tag ~ ':' ~ major_minor_tag %}

      {% elif logic == 'version_rhel' %}
        {% set is_v3_or_higher = raw_version | split('.') | first | int >= 3 %}
        {% set rhel_tag = 'rhel9' if is_v3_or_higher else 'rhel8' %}
        {% set final_url = config.image_base ~ rhel_tag ~ ':' ~ raw_version %}

      {% elif logic == 'version' %}
        {% set final_url = config.image_base ~ raw_version %}

      {% else %}
        {% set final_url = 'Error: Unknown tag_logic' %}
      {% endif %}
      {{ final_url | trim }}
    component_version: "{{ raw_version }}"

- name: Assert Cluster | Final confirmation of dynamic image selection (non-AAP)
  ansible.builtin.assert:
    that:
      - ocp_must_gather_image_custom is defined
      - ocp_must_gather_image_custom | length > 0
    fail_msg: >-
      FAILED! Oh, No! => The final Must Gather Image could not be constructed
      for component {{ component_key | upper }}. Please check the version retrieval and
      tag logic.
    success_msg: >-
      PASSED! Oh, Yes! => Final Must Gather Image for component
      {{ component_key | upper }} | constructed successfully:
      {{ ocp_must_gather_image_custom | trim }}. Proceeding to next steps...
  when:
    - selected_component_config is defined
    - component_key is defined
    - component_key != 'aap'

- name: Assert Cluster | Final confirmation of AAP operators processing
  ansible.builtin.assert:
    that:
      - aap_operators_processed is defined
      - aap_operators_processed | length > 0
    fail_msg: >-
      FAILED! Oh, No! => Could not process discovered AAP operators.
      Please check the version parsing and image construction logic.
    success_msg: >-
      PASSED! Oh, Yes! => Successfully processed {{ aap_operators_processed | length }} AAP operator(s).
      Proceeding to next steps...
  when:
    - component_key is defined
    - component_key == 'aap'
    - discovered_operators is defined
    - discovered_operators | length > 0

- name: Assert Cluster | Set fact variables for Must-Gather image construction (non-AAP)
  ansible.builtin.set_fact:
    __component_key: "{{ component_key | default('N/A') | upper | trim }}"
    __component_purpose: "{{ selected_component_config.purpose | default('N/A') | trim }}"
    __component_version: "{{ component_version | default('N/A') | trim }}"
    __constructed_image: "{{ ocp_must_gather_image_custom | default('') | trim }}"
  when:
    - selected_component_config is defined
    - component_key is defined
    - component_key != 'aap'

- name: Assert Cluster | Set fact variables for Must-Gather image construction (AAP - use first operator)
  ansible.builtin.set_fact:
    __component_key: "{{ component_key | default('N/A') | upper | trim }}"
    __component_purpose: "{{ selected_component_config.purpose | default('N/A') | trim }}"
    __component_version: "{{ aap_operators_processed[0].version | default('N/A') | trim }}"
    __constructed_image: "{{ aap_operators_processed[0].image | default('') | trim }}"
    __aap_all_operators: "{{ aap_operators_processed }}"
  when:
    - component_key is defined
    - component_key == 'aap'
    - aap_operators_processed is defined
    - aap_operators_processed | length > 0

- name: Assert Cluster | Constructed Must-Gather Image (Minimal JSON) - Non-AAP
  ansible.builtin.debug:
    msg:
      - "MUST-GATHER IMAGE DETAILS"
      - "component_key: {{ __component_key | upper | trim }}"
      - "purpose: {{ __component_purpose | trim }}"
      - "version: {{ __component_version | trim }}"
      - "constructed_image: {{ __constructed_image | trim }}"
  when:
    - selected_component_config is defined
    - component_key is defined
    - component_key != 'aap'

- name: Assert Cluster | Display all discovered AAP operators with images
  ansible.builtin.debug:
    msg:
      - "MUST-GATHER IMAGE DETAILS - AAP OPERATORS"
      - "component_key: {{ component_key | upper }}"
      - "purpose: {{ selected_component_config.purpose }}"
      - "total_operators_discovered: {{ aap_operators_processed | length }}"
      - "NOTE: Must-gather will use the first operator's image, but all operators are listed below:"
      - "operators:"
      - "{{ aap_operators_processed | to_nice_yaml(indent=2) }}"
      - ""
      - "Selected operator for must-gather:"
      - "  namespace: {{ aap_operators_processed[0].namespace }}"
      - "  version: {{ aap_operators_processed[0].version }}"
      - "  image: {{ aap_operators_processed[0].image }}"
  when:
    - component_key is defined
    - component_key == 'aap'
    - aap_operators_processed is defined
    - aap_operators_processed | length > 0

- name: Assert Cluster | Ensure temporary destination directory is empty first
  ansible.builtin.file:
    path: "{{ ocp_must_gather_dest_dir }}"
    state: absent

- name: Assert Cluster | Re-ensure temporary destination directory exists
  ansible.builtin.file:
    path: "{{ ocp_must_gather_dest_dir }}"
    state: directory
    mode: '0755'

- name: Assert Cluster | Get Filesystem Stats using 'df' command
  ansible.builtin.shell: |
    set -o pipefail
    df -kP {{ ocp_must_gather_dest_dir }} | awk 'NR==2 {print $4}'
  register: df_result
  changed_when: false
  run_once: true

- name: Assert Cluster | Set Available Space Fact (in Bytes)
  ansible.builtin.set_fact:
    must_gather_space_available: "{{ (df_result.stdout | int) * 1024 }}"
  when: df_result.rc == 0
  run_once: true

- name: Assert Cluster | Assert Minimum Free Space (5 GB Floor)
  ansible.builtin.assert:
    that:
      # Check available space (bytes) > 5 billion bytes (5 GB)
      - must_gather_space_available | int > 5000000000
    fail_msg: >
      [FATAL] Insufficient local disk space on the Execution Host (EE).
      Target directory '{{ ocp_must_gather_dest_dir }}' has only
      {{ (must_gather_space_available | int / (1024 * 1024 * 1024)) | round(2) }} GB available.
      Please ensure at least 5 GB is free.
    success_msg: "PASSED! Oh, Yes! => Disk space validation succeeded. At least 5 GB is available for must-gather output. Proceeding..."
  when: must_gather_space_available is defined
  run_once: true

- name: Assert Cluster | Print available space for must-gather output
  ansible.builtin.debug:
    msg:
      inventory_hostname: "{{ inventory_hostname }}"
      must_gather_dest_dir: "{{ ocp_must_gather_dest_dir }}"
      available_gb: "{{ (must_gather_space_available | int / (1024 * 1024 * 1024)) | round(2) }}"
  when: must_gather_space_available is defined
  run_once: true

- name: Assert Cluster | Print on screen post-login validation complete
  ansible.builtin.debug:
    msg:
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
      - " {{ message_text }} "
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
  vars:
    message_text: "Post-Login Cluster Validation Checks Completed Successfully"
  run_once: true
...
