# --- Generate Must Gather Task File (Data Collection Execution) ---
---
- name: Generate | Print on screen must-gather execution initiation status.
  ansible.builtin.debug:
    msg:
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
      - " {{ message_text }} "
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
  vars:
    message_text: "Initiating OpenShift Must-Gather Data Collection Process"
  run_once: true

- name: Generate | Ensure temporary destination directory is empty first
  ansible.builtin.file:
    path: "{{ ocp_must_gather_dest_dir }}"
    state: absent

- name: Generate | Re-ensure temporary destination directory exists
  ansible.builtin.file:
    path: "{{ ocp_must_gather_dest_dir }}"
    state: directory
    mode: '0755'

- name: "Generate | DEBUG: Preparing Final Cluster Execution Command"
  ansible.builtin.debug:
    msg: |
      {{ separator_char * (message_text | length + default_message_padding) | int }}
      {{ message_text }}
      {{ separator_char * (message_text | length + default_message_padding) | int }}

      --- NOTICE ---
      The following command will now be executed against the authenticated 
      **OCP Cluster '{{ cluster_name }}'**. This process takes time.
      Please be patient and do not cancel the execution.
      
      {% if ocp_disconnected_mode | default(false) | bool %}
      >> DISCONNECTED MODE ACTIVE: Image will be pulled from {{ ocp_disconnected_registry }}.
      {% endif %}
      --------------------------------------------------
      Final Command to be Executed:
      --------------------------------------------------
      $ oc adm must-gather
        --dest-dir={{ ocp_must_gather_dest_dir }}
        {% if ocp_disconnected_mode | bool and ocp_disconnected_registry | length > 0 %}
        --image={{ ocp_disconnected_registry | trim }}
        {% elif __constructed_image is defined and __constructed_image | length > 0 %}
        --image={{ __constructed_image | trim }}
        {% endif %}
        {% if ocp_must_gather_since | default('') | length > 0 %}
        --since={{ ocp_must_gather_since }}
        {% endif %}
        {{ ocp_must_gather_options | default('') }}
      --------------------------------------------------

  vars:
    message_text: ">>>> PREVIEW: MUST-GATHER CLUSTER EXECUTION STAGE <<<<<"

- name: Generate | Must-Gather (ASYNC Operation - DO NOT CANCEL)
  ansible.builtin.shell: >
    oc adm must-gather
    --dest-dir={{ ocp_must_gather_dest_dir }}
    {% if ocp_disconnected_mode | bool and ocp_disconnected_registry | length > 0 %}
    --image={{ ocp_disconnected_registry | trim }}
    {% elif __constructed_image is defined and __constructed_image | length > 0 %}
    --image={{ __constructed_image | default('') | trim }}
    {% endif %}
    {% if ocp_must_gather_since | default('') | length > 0 %}
    --since={{ ocp_must_gather_since }}
    {% endif %}
    {{ ocp_must_gather_options | default('') }}
  register: must_gather_result
  changed_when: must_gather_result.rc == 0
  failed_when: false  # Prevent failure here, allowing the subsequent assert task to handle the error message.
  async: 1800
  poll: 10

- name: Generate | Assert must-gather command succeeded
  ansible.builtin.assert:
    that:
      - must_gather_result.rc == 0
    fail_msg: |
      FAILED! Oh. No! => The must-gather collection of cluster resources and logs command failed!
      
      This failure often indicates one of the following issues:
      
      1. **Cluster State/Permissions:** Missing 'cluster-admin' privileges or cluster is unhealthy.
      2. **Image/Registry Issue:** The custom image is inaccessible or incorrect.
        > Image Used: {% if ocp_disconnected_mode | default(false) | bool and ocp_disconnected_registry | length > 0 %}{{ ocp_disconnected_registry | trim }}{% elif __constructed_image is defined and __constructed_image | length > 0 %}{{ __constructed_image | trim }}{% else %}Default Data Collection{% endif %}
      
      {# --- Disconnected Mode Check --- #}
      {% if ocp_disconnected_mode | default(false) | bool %}
      3. **Disconnected Check:** You selected disconnected mode. Verify the registry address is correct and the image stream (must-gather) is mirrored/imported into {{ ocp_disconnected_registry }}.
          > Registry Used: {{ ocp_disconnected_registry }}
      {% endif %}
      
      --------------------------------------------------
      Execution Details:
      --------------------------------------------------
      > Return Code: {{ must_gather_result.rc }}
      > Stdout: {{ must_gather_result.stdout | default('N/A') }}
      > Stderr: {{ must_gather_result.stderr | default('N/A') }}
      
    success_msg: "PASSED! Oh, Yes! => The must-gather collection of cluster resources and logs completed successfully, using the specified image. Proceeding to archive the results..."
  when: must_gather_result is defined

- name: Generate | Print on screen must-gather data collection completion status.
  ansible.builtin.debug:
    msg:
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
      - " {{ message_text }} "
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
  vars:
    message_text: "OpenShift Must-Gather Data Collection Process Completed Successfully"
  run_once: true
...
