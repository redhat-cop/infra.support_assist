# --- Main Task File: assert_vars.yml (Pre-Login Local Validation) ---
---
- name: Assert Vars | Print on screen pre-flight execution status - (Local Validation).
  ansible.builtin.debug:
    msg:
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
      - " {{ message_text }} "
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
  vars:
    message_text: "Executing Pre-Flight Checks and Dynamic Image Validation - (Local Validation)"
  run_once: true

- name: Assert Vars | Assert that required variables are defined
  ansible.builtin.assert:
    that:
      - item.name is defined
      - item.name | length > 0
    fail_msg: "FAILED! Oh, No! => The required variable '{{ item.name }}' is missing or empty. This variable is essential for the ocp_must_gather role. Please check the Job Template Survey."
    success_msg: "PASSED! Oh, Yes! => Required variable '{{ item.name }}' is defined. Proceeding..."
  loop:
    - { name: ocp_must_gather_token }
    - { name: ocp_must_gather_server_url }
    - { name: case_id }
  vars:
    ansible_loop_var: item

- name: Assert Vars | Set cluster_name from API URL
  ansible.builtin.set_fact:
    cluster_name: "{{ ocp_must_gather_server_url | regex_replace('^(http[s]?://api\\.)', '') | regex_replace('(\\..*)$', '') }}"

- name: Assert Vars | Assert that cluster_name was successfully extracted
  ansible.builtin.assert:
    that:
      - cluster_name is defined
      - cluster_name | length > 0
      - cluster_name != 'api' 
    fail_msg: "FAILED! Oh, No! => Could not reliably extract the cluster name from the API URL ('{{ ocp_must_gather_server_url }}'). The URL format may be unexpected."
    success_msg: "PASSED! Oh, Yes! => Cluster name '{{ cluster_name }}' extracted successfully from API URL."
  when: ocp_must_gather_server_url is defined and ocp_must_gather_server_url | length > 0

- name: Assert Vars | Check if 'oc' command exists on execution host
  ansible.builtin.command: command -v oc
  register: oc_check
  changed_when: false
  ignore_errors: true

- name: Assert Vars | Assert 'oc' command is available on execution host
  ansible.builtin.assert:
    that:
      - oc_check.rc == 0
    fail_msg: "FAILED! Oh, No! => The 'oc' command was not found on the execution host ({{ inventory_hostname }}). Please ensure the OpenShift CLI is installed and in the system's PATH."
    success_msg: "PASSED! Oh, Yes! => The 'oc' command is found and ready on the execution host. Proceeding..."
  when: oc_check is defined

- name: Assert Vars | Set dynamic component configuration and key (from user acronym)
  # The component_key is the user input (acronym). Lookup is performed on the lowercase version.
  ansible.builtin.set_fact:
    component_key: "{{ ocp_must_gather_image }}"
    # Lookup the configuration data using the lowercase acronym as the key.
    selected_component_config: "{{ must_gather_components[ocp_must_gather_image | lower] }}"
  # Only run this logic if the user selected a custom component (not the default baseline)
  when: ocp_must_gather_image | upper != 'DEFAULT'

- name: Assert Vars | Assert user selected a valid component acronym
  ansible.builtin.assert:
    that:
      # Check if the input is 'DEFAULT' OR if the acronym exists in the components list.
      - ocp_must_gather_image | upper == 'DEFAULT' or selected_component_config is defined
    fail_msg: "FAILED! Oh, No! => The selected Must Gather Acronym ('{{ ocp_must_gather_image }}') is not a valid component option. Please select an option from the available acronyms (or 'DEFAULT')."
    success_msg: "PASSED! Oh, Yes! => Component mapping successful. Proceeding to version check..."
  # Only validate if the image variable was provided/is not empty
  when: ocp_must_gather_image is defined and ocp_must_gather_image | length > 0

- name: Assert Vars | Execute version command for selected component to retrieve operator version ( SHELL )
  ansible.builtin.shell: "{{ selected_component_config.version_command }}"
  register: component_version_result
  changed_when: false
  failed_when: false
  when: selected_component_config is defined

- name: Assert Vars | Assert that version command executed successfully
  ansible.builtin.assert:
    that:
      - component_version_result.rc is defined
      - component_version_result.rc == 0
    fail_msg: 
      "FAILED! Oh, No! => The version command for component {{ component_key }}. Please check if the Operator is installed and the authentication is correct."
    success_msg: 
      "PASSED! Oh, Yes! => Version command for component '{{ component_key }}' executed successfully. Proceeding to extract version..."
  when: selected_component_config is defined

- name: Assert Vars | Set raw_version fact for consumption
  ansible.builtin.set_fact:
    raw_version: "{{ component_version_result.stdout | trim }}"
  when:
    - component_version_result is defined
    - component_version_result.rc is defined 
    - component_version_result.rc == 0       

- name: Assert Vars | Assert component operator version was successfully retrieved
  ansible.builtin.assert:
    that:
      - raw_version is defined
      - raw_version | length > 0
    fail_msg: "FAILED! Oh, No! => Component '{{ component_key }}' was selected but the operator version could not be retrieved (RC: {{ component_version_result.rc | default('N/A') }}). This means the Operator is likely NOT installed, or the authentication is incorrect. Check: oc get csv -n <namespace>."
    success_msg: "PASSED! Oh, Yes! => Component '{{ component_key }}' version ({{ raw_version }}) retrieved successfully. Proceeding to construct the image tag..."
  when: raw_version is defined

- name: Assert Vars | Construct and set the final versioned image string
  when: raw_version is defined
  ansible.builtin.set_fact:
    ocp_must_gather_image_custom: >-
      {% set raw_version = raw_version | default('') %}
      {% set config = selected_component_config %}
      {% set logic = config.tag_logic | trim %}
      
      {# 1. Extract Major.Minor (e.g., '2.6' from '2.6.0+...') #}
      {% set version_parts = raw_version | split('.') %}
      {% set major_minor_tag = version_parts[0] ~ '.' ~ version_parts[1] | default('') %}
      
      {# 2. Convert Major.Minor (e.g., '2.6') to number string ('26') for AAP path #}
      {% set major_minor_num_str = major_minor_tag | replace('.', '') %}

      {% set final_url = "" %}
      
      {% if logic == 'raw' %}
        {% set final_url = raw_version %}
      {% elif logic == 'major_minor' %}
        {% set final_url = config.image_base ~ major_minor_tag %}
      {% elif logic == 'aap_dynamic_rhel' %}
        {% set major_num_int = major_minor_tag | split('.') | first | int %}
        {% set rhel_suffix = "/aap-must-gather-rhel8" %}
        
        {% if major_minor_num_str | int >= 26 %}
          {% set rhel_suffix = "/aap-must-gather-rhel9" %}
        {% endif %}
        
        {% set final_url = config.image_base_prefix ~ major_minor_num_str ~ rhel_suffix %}
      
      {% elif logic == 'major_minor_rhel' %}
        {% set is_v3_or_higher = raw_version | split('.') | first | int >= 3 %}
        {% set rhel_tag = 'rhel9' if is_v3_or_higher else 'rhel8' %}
        {% set final_url = config.image_base ~ rhel_tag ~ ':' ~ major_minor_tag %}
      
      {% elif logic == 'version_rhel' %}
        {% set is_v3_or_higher = raw_version | split('.') | first | int >= 3 %}
        {% set rhel_tag = 'rhel9' if is_v3_or_higher else 'rhel8' %}
        {% set final_url = config.image_base ~ rhel_tag ~ ':' ~ raw_version %}
      
      {% elif logic == 'version' %}
        {% set final_url = config.image_base ~ raw_version %}
        
      {% else %}
        {% set final_url = 'Error: Unknown tag_logic' %}
      {% endif %}
      {{ final_url | trim }}
    component_version: "{{ raw_version }}"

- name: Assert Vars | Final confirmation of dynamic image selection
  ansible.builtin.assert:
    that:
      - ocp_must_gather_image_custom is defined
      - ocp_must_gather_image_custom | length > 0
    fail_msg: "FAILED! Oh, No! => The final Must Gather Image could not be constructed for component {{ component_key }}. Please check the version retrieval and tag logic."
    success_msg: "PASSED! Oh, Yes! => Final Must Gather Image for component {{ component_key }} | constructed successfully: {{ ocp_must_gather_image_custom | trim }}. Proceeding to next steps..."
  when: selected_component_config is defined

- name: Assert Vars | Set fact variables for Must-Gather image construction
  ansible.builtin.set_fact:
    __component_key: "{{ component_key | default('N/A') | trim }}"
    __component_purpose: "{{ selected_component_config.purpose | default('N/A') | trim }}"
    __component_version: "{{ component_version | default('N/A') | trim }}"
    __constructed_image: "{{ ocp_must_gather_image_custom | default('') | trim }}"
  when: selected_component_config is defined

- name: Assert Vars | Print on screen pre-login validation complete
  ansible.builtin.debug:
    msg:
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
      - " {{ message_text }} "
      - "{{ separator_char * (message_text | length + default_message_padding) | int }}"
  vars:
    message_text: "Pre-Flight Checks and Dynamic Image Validation Complete - (Local Validation)"
  run_once: true
...
# --- End of Main Task File: assert_vars.yml (Pre-Login Local Validation) ---